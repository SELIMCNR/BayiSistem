<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bağlan360 Yönetim Paneli | Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      /* Yönetim Paneline özel estetik CSS */
      body {
        background-color: #f4f7f9; /* Hafif bir yönetici paneli arka planı */
      }
      .panel-card {
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }
      .nav-tabs .nav-link.active {
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
        color: #0d6efd;
        font-weight: bold;
      }
      .status-badge {
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        font-size: 0.85em;
        padding: 0.5em 0.8em;
        min-width: 90px;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      .status-badge:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .table-hover tbody tr:hover {
        background-color: #e9ecef;
      }
      .table-striped > tbody > tr:nth-of-type(odd) {
        --bs-table-bg-type: #f9f9f9;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand mb-0 h1 ps-3" href="/">
          <i class="bi bi-gear-fill me-2"></i> **Bağlan360 Yönetim Paneli**
        </a>
        <!-- Çıkış Butonu -->
        <a
          href="/logout"
          class="btn btn-outline-danger"
          onclick="return confirm('Gerçekten çıkış yapmak istiyor musunuz?');"
        >
          <i class="fas fa-sign-out-alt me-1"></i> Çıkış Yap
        </a>
      </div>
    </nav>
    <div class="container my-5">
      <div class="card panel-card">
        <div class="card-body p-4">
          <ul class="nav nav-tabs mb-4" id="panelTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="basvuru-tab"
                data-bs-toggle="tab"
                data-bs-target="#basvuru"
                type="button"
                role="tab"
                aria-controls="basvuru"
                aria-selected="true"
              >
                <i class="bi bi-file-earmark-spreadsheet me-2"></i> Başvurular
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="altyapi-tab"
                data-bs-toggle="tab"
                data-bs-target="#altyapi"
                type="button"
                role="tab"
                aria-controls="altyapi"
                aria-selected="false"
              >
                <i class="bi bi-hdd-network me-2"></i> Altyapı Talepleri
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="bayilik-tab"
                data-bs-toggle="tab"
                data-bs-target="#bayilik"
                type="button"
                role="tab"
                aria-controls="bayilik"
                aria-selected="false"
              >
                <i class="bi bi-shop me-2"></i> Bayilik Başvuruları
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="iletisim-tab"
                data-bs-toggle="tab"
                data-bs-target="#iletisim"
                type="button"
                role="tab"
                aria-controls="iletisim"
                aria-selected="false"
              >
                <i class="bi bi-inbox me-2"></i> İletişim Mesajları
              </button>
            </li>
          </ul>
          <div class="tab-content" id="panelTabsContent">
            <div
              class="tab-pane fade show active"
              id="basvuru"
              role="tabpanel"
              aria-labelledby="basvuru-tab"
            >
              <h4 class="mb-3">İnternet Başvuru Listesi</h4>
              <div class="table-responsive">
                <table
                  class="table table-bordered table-striped table-hover align-middle"
                >
                  <thead class="table-dark">
                    <tr>
                      <th>ID</th>
                      <th>Ad Soyad</th>
                      <th>Telefon</th>
                      <th>Adres</th>
                      <th>Paket</th>
                      <th>Durum</th>
                    </tr>
                  </thead>
                  <tbody id="basvuruTable">
                    <tr>
                      <td colspan="6" class="text-center">
                        Veriler yükleniyor...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div
              class="tab-pane fade"
              id="altyapi"
              role="tabpanel"
              aria-labelledby="altyapi-tab"
            >
              <h4 class="mb-3">Altyapı Sorgulama Talepleri</h4>
              <div class="table-responsive">
                <table
                  class="table table-bordered table-striped table-hover align-middle"
                >
                  <thead class="table-dark">
                    <tr>
                      <th>ID</th>
                      <th>Adres</th>
                      <th>Tarih</th>
                      <th>Durum</th>
                    </tr>
                  </thead>
                  <tbody id="altyapiTable">
                    <tr>
                      <td colspan="4" class="text-center">
                        Veriler yükleniyor...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div
              class="tab-pane fade"
              id="bayilik"
              role="tabpanel"
              aria-labelledby="bayilik-tab"
            >
              <h4 class="mb-3">Bayilik Başvuruları Listesi</h4>
              <div class="table-responsive">
                <table
                  class="table table-bordered table-striped table-hover align-middle"
                >
                  <thead class="table-dark">
                    <tr>
                      <th>ID</th>
                      <th>Ad Soyad</th>
                      <th>Telefon</th>
                      <th>E-Posta</th>
                      <th>İl</th>
                      <th>Mesaj</th>
                      <th>Durum</th>
                    </tr>
                  </thead>
                  <tbody id="bayilikTable">
                    <tr>
                      <td colspan="7" class="text-center">
                        Veriler yükleniyor...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div
              class="tab-pane fade"
              id="iletisim"
              role="tabpanel"
              aria-labelledby="iletisim-tab"
            >
              <h4 class="mb-3">İletişim Mesajları Listesi</h4>
              <div class="table-responsive">
                <table
                  class="table table-bordered table-striped table-hover align-middle"
                >
                  <thead class="table-dark">
                    <tr>
                      <th>ID</th>
                      <th>Ad Soyad</th>
                      <th>E-Posta</th>
                      <th>Konu</th>
                      <th>Mesaj</th>
                      <th>Tarih</th>
                      <th>Durum</th>
                    </tr>
                  </thead>
                  <tbody id="iletisimTable">
                    <tr>
                      <td colspan="7" class="text-center">
                        Veriler yükleniyor...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="statusModal"
      tabindex="-1"
      aria-labelledby="statusModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="statusModalLabel">
              <i class="bi bi-arrow-repeat me-2"></i> **Kayıt Durumunu
              Güncelle**
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Kapat"
            ></button>
          </div>
          <div class="modal-body">
            <p class="lead mb-2">
              Seçili Kayıt ID:
              <strong id="modalItemId" class="text-primary"></strong>
            </p>
            <p>
              Mevcut Durum:
              <span id="modalCurrentStatus" class="badge p-2"></span>
            </p>

            <h6 class="mt-4 mb-3 fw-bold border-bottom pb-2">
              Yeni Durumu Seçin:
            </h6>
            <div id="newStatusOptions"></div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              İptal
            </button>
            <button type="button" class="btn btn-primary" id="saveStatusBtn">
              <span
                class="spinner-border spinner-border-sm me-2 d-none"
                role="status"
                aria-hidden="true"
              ></span>
              <i class="bi bi-save me-1"></i> Kaydet ve Güncelle
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Durum haritası sabitleri
      const statusMap = {
        Bekliyor: { text: "Bekliyor", class: "bg-warning text-dark" },
        İşlemde: { text: "İşlemde", class: "bg-info text-dark" },
        Tamamlandı: { text: "Tamamlandı", class: "bg-success" },
        Reddedildi: { text: "Reddedildi", class: "bg-danger" },
      };

      // Modal bileşenlerini ve aktif kaydı tutan değişkenler
      const statusModal = new bootstrap.Modal(
        document.getElementById("statusModal")
      );
      const saveStatusBtn = document.getElementById("saveStatusBtn");
      let activeUpdate = { id: null, type: null, badgeElement: null };

      function getStatusBadge(status) {
        const map = statusMap[status] || statusMap.Bekliyor;
        return `<span class="badge ${map.class} status-badge" data-status="${map.text}">${map.text}</span>`;
      }

      // Veri çekme ve tabloları doldurma
      async function fetchData(url, tableBodyId, type) {
        const tableBody = document.getElementById(tableBodyId);

        // Sütun sayısını tipe göre ayarla
        let colspan;
        if (type === "basvuru") colspan = 6;
        else if (type === "altyapi") colspan = 4;
        else colspan = 7; // bayilik ve iletisim

        tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Veriler yükleniyor...</td></tr>`;

        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error("Veri çekilemedi. Sunucu hatası.");
          const data = await response.json();

          tableBody.innerHTML = "";
          if (data.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-muted"><i class="bi bi-x-circle me-2"></i> Kayıt bulunamadı.</td></tr>`;
            return;
          }

          data.forEach((item) => {
            let row = `<tr><td>${item.id}</td>`;

            if (type === "basvuru") {
              row += `
                <td>${item.ad}</td>
                <td><a href="tel:${
                  item.telefon
                }" class="text-decoration-none">${item.telefon}</a></td>
                <td title="${item.adres || "-"}">${(
                item.adres || "-"
              ).substring(0, 40)}...</td>
                <td>${item.paket || "-"}</td>
              `;
            } else if (type === "altyapi") {
              row += `
                <td title="${item.adres}">${item.adres.substring(0, 60)}...</td>
                <td>${new Date(item.tarih).toLocaleDateString("tr-TR", {
                  day: "numeric",
                  month: "short",
                  year: "numeric",
                })}</td>
              `;
            } else if (type === "bayilik") {
              row += `
                <td>${item.adSoyad}</td>
                <td><a href="tel:${
                  item.telefon
                }" class="text-decoration-none">${item.telefon}</a></td>
                <td><a href="mailto:${
                  item.ePosta
                }" class="text-decoration-none">${item.ePosta || "-"}</a></td>
                <td>${item.il || "-"}</td>
                <td title="${item.mesaj}">${item.mesaj.substring(0, 30)}...</td>
              `;
            } else if (type === "iletisim") {
              row += `
                <td>${item.ad}</td>
                <td><a href="mailto:${
                  item.email
                }" class="text-decoration-none">${item.email}</a></td>
                <td>${item.konu || "-"}</td>
                <td title="${item.mesaj}">${item.mesaj.substring(
                0,
                30
              )}...</td> 
                <td>${new Date(item.tarih).toLocaleDateString("tr-TR", {
                  day: "numeric",
                  month: "short",
                  year: "numeric",
                })}</td>
              `;
            }

            row += `
              <td>${getStatusBadge(item.durum)}</td>
            </tr>`;
            tableBody.innerHTML += row;
          });

          // Durum Güncelleme Olay Dinleyicileri Ekleme
          document
            .querySelectorAll(`#${tableBodyId} .status-badge`)
            .forEach((badge) => {
              badge.addEventListener("click", (e) =>
                showStatusChangeModal(e.target, type)
              );
            });
        } catch (error) {
          tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-danger">Hata: ${error.message}</td></tr>`;
        }
      }

      // Durum değiştirme modalını açan fonksiyon
      function showStatusChangeModal(badgeElement, type) {
        const row = badgeElement.closest("tr");
        const itemId = row.cells[0].textContent;
        const currentStatus = badgeElement.dataset.status;

        // Aktif güncelleme bilgisini kaydet
        activeUpdate.id = itemId;
        activeUpdate.type = type;
        activeUpdate.badgeElement = badgeElement;

        // Modal içeriklerini doldur
        document.getElementById("modalItemId").textContent = itemId;

        // Mevcut durum rozetini ayarla
        const currentBadge = document.getElementById("modalCurrentStatus");
        currentBadge.textContent = currentStatus;
        Object.values(statusMap).forEach((map) =>
          currentBadge.classList.remove(map.class)
        );
        currentBadge.classList.add(
          statusMap[currentStatus]?.class || statusMap.Bekliyor.class
        );

        // Radyo butonlarını oluştur
        const optionsDiv = document.getElementById("newStatusOptions");
        optionsDiv.innerHTML = Object.keys(statusMap)
          .map((status) => {
            const checked = status === currentStatus ? "checked disabled" : "";
            const badgeClass =
              statusMap[status]?.class || statusMap.Bekliyor.class;
            return `
                  <div class="form-check mb-2">
                      <input class="form-check-input" type="radio" name="newStatus" id="status-${status}" value="${status}" ${checked}>
                      <label class="form-check-label" for="status-${status}">
                          <span class="badge ${badgeClass} p-2" style="min-width: 90px; display: inline-block;">${status}</span>
                      </label>
                  </div>
              `;
          })
          .join("");

        statusModal.show();
      }

      // Durum Güncelleme API çağrısı
      async function updateStatus(id, type, durum) {
        const spinner = saveStatusBtn.querySelector(".spinner-border");

        spinner.classList.remove("d-none");
        saveStatusBtn.disabled = true;

        try {
          const response = await fetch("/admin-api/update-status", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: id, type: type, durum: durum }),
          });

          const result = await response.json();

          statusModal.hide();

          if (result.success) {
            alert(
              `${id} ID'li kaydın durumu başarıyla "${durum}" olarak güncellendi.`
            );

            // Tabloyu yeniden yükle (type'a göre doğru endpoint ve tabloyu seçerek)
            let url, tableId;
            if (type === "basvuru") {
              url = "/admin-api/basvurular";
              tableId = "basvuruTable";
            } else if (type === "altyapi") {
              url = "/admin-api/altyapi";
              tableId = "altyapiTable";
            } else if (type === "bayilik") {
              url = "/admin-api/bayilik";
              tableId = "bayilikTable";
            } else if (type === "iletisim") {
              url = "/admin-api/iletisim";
              tableId = "iletisimTable";
            }

            if (url && tableId) {
              fetchData(url, tableId, type);
            }
          } else {
            alert("Güncelleme başarısız: " + result.message);
          }
        } catch (error) {
          statusModal.hide();
          alert("Sunucuya bağlanılamadı. Durum güncellenemedi.");
        } finally {
          spinner.classList.add("d-none");
          saveStatusBtn.disabled = false;
        }
      }

      // Modal Kaydet butonuna olay dinleyicisi ekle
      saveStatusBtn.addEventListener("click", () => {
        const selectedStatus = document.querySelector(
          'input[name="newStatus"]:checked'
        );
        if (selectedStatus && activeUpdate.id && activeUpdate.type) {
          updateStatus(
            activeUpdate.id,
            activeUpdate.type,
            selectedStatus.value
          );
        } else {
          alert("Lütfen yeni bir durum seçiniz.");
        }
      });

      // Sayfa yüklendiğinde verileri çek ve sekme değişimlerini ayarla
      document.addEventListener("DOMContentLoaded", () => {
        // 1. Başvuruları yükle (Aktif sekme)
        fetchData("/admin-api/basvurular", "basvuruTable", "basvuru");

        // 2. Altyapı taleplerini sekme değiştiğinde yükle
        document
          .getElementById("altyapi-tab")
          .addEventListener("shown.bs.tab", () => {
            fetchData("/admin-api/altyapi", "altyapiTable", "altyapi");
          });

        // 3. Bayilik başvurularını sekme değiştiğinde yükle
        document
          .getElementById("bayilik-tab")
          .addEventListener("shown.bs.tab", () => {
            fetchData("/admin-api/bayilik", "bayilikTable", "bayilik");
          });

        // 4. İletişim mesajlarını sekme değiştiğinde yükle
        document
          .getElementById("iletisim-tab")
          .addEventListener("shown.bs.tab", () => {
            fetchData("/admin-api/iletisim", "iletisimTable", "iletisim");
          });
      });
    </script>
  </body>
</html>
